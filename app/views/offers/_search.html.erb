<div id="searchbar" class="hidden">
  <input type="text" id="searchbar-input" autofocus="true">
  <div id="searchbar-input-icon"><i class='fa fa-search'></i></div>
</div>


<div id="search-page-wrapper" class="padded-top-xxxl padded-bottom-xxl bg-light-gray hidden">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-lg-10 col-lg-offset-1">

        <div class="search-filters bg-white-transparent">
          <div id="search-amounts" class="padded-bottom-xs"></div>
          <div id="search-languages" class="padded-bottom-xs"></div>
          <div id="search-means" class="padded-bottom-xs"></div>
          <div id="search-rating"></div>
        </div>

        <div class="search-infos padded-top-xs">
          <div id="search-stats"></div>
          <div id="search-sort-by-wrapper"><span id="search-sort-by"></span></div>
        </div>

        <div id="search-hits"></div>

        <div id="search-pagination"></div>

        <script type="text/html" id="search-hit-template">
          <%= render "offers/card_instant" %>
        </script>

        <script type="text/html" id="search-no-results-template">
          <p>Sorry, we didn't find any offers matching the search <em>"{{query}}"</em>...</p>
        </script>

        <script src="https://cdn.jsdelivr.net/instantsearch.js/1/instantsearch.min.js"></script>
        <script>
          var search = instantsearch({
            appId: "<%= ENV['ALGOLIA_APPLICATION_ID'] %>",
            apiKey: "<%= ENV['ALGOLIA_SEARCH_ONLY_API_KEY'] %>",
            indexName: "Offer_" + "<%= ENV['RAILS_ENV'] %>",
            urlSync: false
          });

          search.addWidget(
            instantsearch.widgets.searchBox({
              container: '#searchbar-input',
              placeholder: 'I need some advice for ...'
            })
          );

          search.addWidget(
            instantsearch.widgets.hits({
              container: '#search-hits',
              templates: {
                item: getTemplate('search-hit'),
                empty: getTemplate('search-no-results')
              }
            })
          );

          search.addWidget(
            instantsearch.widgets.stats({
              container: '#search-stats',
            })
          );

          search.addWidget(
            instantsearch.widgets.sortBySelector({
              container: '#search-sort-by',
              autoHideContainer: true,
              indices: [{
                name: search.indexName, label: 'Most relevant'
              }, {
                name: "Offer_price_asc_" + "<%= ENV['RAILS_ENV'] %>", label: 'Lowest price'
              }, {
                name: "Offer_price_desc_" + "<%= ENV['RAILS_ENV'] %>", label: 'Highest price'
              }]
            })
          );

          search.addWidget(
            instantsearch.widgets.pagination({
              container: '#search-pagination'
            })
          );

          search.addWidget(
            instantsearch.widgets.refinementList({
              container: '#search-languages',
              attributeName: 'languages.label',
              sortBy: ['isRefined', 'count:desc', 'name:asc'],
              operator: 'or',
              limit: 5,
              showMore: true,
              templates: {
                header: '<h6>Languages</h6>'
              }
            })
          );

          search.addWidget(
            instantsearch.widgets.refinementList({
              container: '#search-means',
              attributeName: 'means.label',
              sortBy: ['isRefined', 'count:desc', 'name:asc'],
              operator: 'or',
              limit: 5,
              showMore: true,
              templates: {
                header: '<h6>Means of communication</h6>'
              }
            })
          );

          search.addWidget(
            instantsearch.widgets.rangeSlider({
              container: '#search-amounts',
              attributeName: 'median_amount',
              templates: {
                header: '<h6>Median price of sessions</h6>'
              },
              tooltips: {
                format: function(rawValue) {
                  return Math.round(rawValue).toLocaleString() + ' â‚¬';
                }
              },
            })
          );

          function getTemplate(templateName) {
            return document.getElementById(templateName + '-template').innerHTML;
          }

          search.start();
        </script>

      </div>
    </div>
  </div>
</div>
